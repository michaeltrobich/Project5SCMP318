
<!DOCTYPE html>
<html>

<head>
  <script src="https://cdn.rawgit.com/konvajs/konva/2.0.2/konva.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <meta charset="utf-8">
  <title>Friends.</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: #ffffff;
    }
  </style>
</head>

<body>
    <div id="container"></div>
  <script>
  //SOCKET.IO STUFF
  var socket = io();
  var color;

  socket.on('setColor', function(id) {
    if (id == "blue") {
      color = 'blue';
      console.log(color);
    }
    else if (id == "red") {
      color = 'red';
      console.log(color);
	  blusquare.hide();
	  layer.draw();
    }
  });

  socket.on('full', function(x) {
    if (x) {
      alert("Sorry, the game is full!");
    }
    socket.emit('disconnect');
  });

  //KONVA STUFF
  //var color ='red';
	//var level = 8;
  var level = 0;

  socket.on('start', function(x) {
    if (x) {
      //console.log(level);
      level = 1;
      //console.log(level);
      reset();
      levelup(level);
    }
  });

	//First, the stage and the groups.
	var stage = new Konva.Stage({
      container: 'container',
      width: window.innerWidth,
      height: window.innerHeight
    });

    var layer = new Konva.Layer();

	var textGroup = new Konva.Group({
		x:0,
		y:0,
	});

	 var topGroup = new Konva.Group({
        x: 50,
        y: 100,
    });
    var bottomGroup = new Konva.Group({
        x: 50,
        y: 300,
    });

	//Then, the level texts.

	var player = new Konva.Text({
		x: 500,
		y: 300,
		fontSize: 60,
		align: 'center',
		text: 'You are: '
	});

	var loading = new Konva.Text({
		x: 500,
		y: 500,
		fontSize: 60,
		align: 'center',
		text: 'Waiting for friend...'
	});

	var level1 = new Konva.Text({
		x: 110,
		y: 275,
		fontSize: 30,
		align: 'center',
		text: 'These are friends. They help each other. That\'s what friends do.',
		visible: false
	});

	var level2 = new Konva.Text({
		x: 110,
		y: 275,
		fontSize: 30,
		align: 'center',
		text: 'Friends have obstacles in their lives. Like mountains to climb.',
		visible: false
	});

	var level3 = new Konva.Text({
		x: 110,
		y: 275,
		fontSize: 30,
		align: 'center',
		text: 'Some mountains are harder than others.',
		visible: false
	});

	var level4 = new Konva.Text({
		x: 110,
		y: 275,
		fontSize: 30,
		align: 'center',
		text: 'Sometimes, one friend\'s mountains may be higher.',
		visible: false
	});

	var level5 = new Konva.Text({
		x: 110,
		y: 275,
		fontSize: 30,
		align: 'center',
		text: 'And sometimes, one can\'t see what the other\'s going through.',
		visible: false
	});

	var level6 = new Konva.Text({
		x: 110,
		y: 275,
		fontSize: 30,
		align: 'center',
		text: 'We need help from our friends.',
		visible: false
	});

	var level7 = new Konva.Text({
		x: 330,
		y: 20,
		fontSize: 30,
		align: 'center',
		text: 'We have mountains to climb.',
		visible: false
	});

	var level8 = new Konva.Text({
		x: 100,
		y: 500,
		fontSize: 30,
		align: 'center',
		text: 'And sometimes, it feels like there\'s not enough to go around.',
		visible: false
	});

	var level9 = new Konva.Text({
		x: 110,
		y: 275,
		fontSize: 30,
		align: 'center',
		text: 'But your friends aren\'t there to hurt you.',
		visible: false
	});

	var level10 = new Konva.Text({
		x: 110,
		y: 275,
		fontSize: 30,
		align: 'center',
		text: 'Friends help you. That\'s what friends do.',
		visible: false
	});

	//The players.
	var redsquare = new Konva.Rect({
        x: 750,
        y: 225,
        width: 20,
        height: 20,
        fill: 'red',
        stroke: 'red',
		hitFunc: function (context) {
        context.beginPath();
		context.rect(0, 0, redsquare.width(), redsquare.height());
		context.closePath();
		context.fillStrokeShape(this);
      }
    });

	var blusquare = new Konva.Rect({
            x: 750,
            y: 225,
            width: 20,
			height: 20,
            fill: 'blue',
            stroke: 'blue',
			visible: false,
			hitFunc: function (context) {
        context.beginPath();
		context.rect(0, 0 , blusquare.width(), blusquare.height());
		context.closePath();
		context.fillStrokeShape(this);
      }
        });

	//Their platforms.
	var redFloor = new Konva.Line({
      points: [0, 100, 900, 100],
      stroke: 'black',
      strokeWidth: 10,
      lineCap: 'round',
      lineJoin: 'round',
	  visible: false
    });

	var bluFloor = new Konva.Line({
      points: [0, 100, 900, 100],
      stroke: 'black',
      strokeWidth: 10,
      lineCap: 'round',
      lineJoin: 'round',
	  visible : false
    });

	var platform = new Konva.Rect({
            x: 50,
            y: 262.5,
            width: 50,
			height: 50,
            fill: 'black',
            stroke: 'black',
			draggable: true,
			visible: false
        });

	//And the hazards.
	var redspikes = new Konva.RegularPolygon({
            x: 100,
            y: 500,
            sides: 3,
            radius: 20,
            fill: 'red',
            stroke: 'red',
           strokeWidth: 4,
			visible: false
        });

	var bigredspikes = new Konva.RegularPolygon({
            x: 100,
            y: 500,
            sides: 3,
            radius: 100,
            fill: 'red',
            stroke: 'red',
           strokeWidth: 4,
			visible: false
        });

	var moreredspikes = new Konva.RegularPolygon({
            x: 100,
            y: 500,
            sides: 3,
            radius: 20,
            fill: 'red',
            stroke: 'red',
           strokeWidth: 4,
			visible: false
        });

	var bluspikes = new Konva.RegularPolygon({
			x: 200,
            y: 300,
            sides: 3,
            radius: 20,
           fill: 'blue',
            stroke: 'blue',
            strokeWidth: 4,
		   visible: false
       });

	var bigbluspikes = new Konva.RegularPolygon({
            x: 100,
            y: 500,
            sides: 3,
            radius: 100,
            fill: 'blue',
            stroke: 'blue',
           strokeWidth: 4,
			visible: false
        });

	var morebluspikes = new Konva.RegularPolygon({
			x: 200,
            y: 300,
            sides: 3,
            radius: 20,
           fill: 'blue',
            stroke: 'blue',
            strokeWidth: 4,
		   visible: false
       });

	//Moving hazards, because more difficult = more fun.
	var redlevel3anim = new Konva.Animation(function(frame) {
		redspikes.setX(100 * Math.sin(frame.time * 2 * Math.PI / 2000) + 450);
		}, layer);

	var blulevel3anim = new Konva.Animation(function(frame) {
		bluspikes.setX(200 * Math.sin(frame.time * 2 * Math.PI / 4000) + 450);
		}, layer);

	var redlevel4anim = new Konva.Animation(function(frame) {
		bigredspikes.setX(100 * Math.sin(frame.time * 2 * Math.PI / 2000) + 450);
		}, layer);

	var redlevel6anim1 = new Konva.Animation(function(frame) {
		redspikes.setX(100 * Math.sin(frame.time * 2 * Math.PI / 2000) + 350);
		}, layer);

	var redlevel6anim2 = new Konva.Animation(function(frame) {
		moreredspikes.setX(100 * Math.sin(frame.time * 2 * Math.PI / 2000) + 550);
		}, layer);

	var blulevel6anim1 = new Konva.Animation(function(frame) {
		bluspikes.setX(100 * Math.sin(frame.time * 2 * Math.PI / 2000) + 350);
		}, layer);

	var blulevel6anim2 = new Konva.Animation(function(frame) {
		morebluspikes.setX(100 * Math.sin(frame.time * 2 * Math.PI / 2000) + 550);
		}, layer);

	var redlevel8anim1 = new Konva.Animation(function(frame) {
		redspikes.setY(50 * Math.sin(frame.time * 2 * Math.PI / 2000) + 35);
		redspikes.setX(50 * Math.sin(frame.time * 2 * Math.PI / 1000) + 275);
		}, layer);

	var redlevel8anim2 = new Konva.Animation(function(frame) {
		moreredspikes.setY(50 * Math.sin(frame.time * 2 * Math.PI / 2000) + 35);
		moreredspikes.setX(50 * Math.sin(frame.time * 2 * Math.PI / 1000) + 575);
		}, layer);

	var blulevel8anim1 = new Konva.Animation(function(frame) {
		bluspikes.setY(25 * Math.sin(frame.time * 2 * Math.PI / 500) + 60);
		bluspikes.setX(100 * Math.sin(frame.time * 2 * Math.PI / 2000) + 300);
		}, layer);

	var blulevel8anim2 = new Konva.Animation(function(frame) {
		morebluspikes.setY(25 * Math.sin(frame.time * 2 * Math.PI / 500) + 60);
		morebluspikes.setX(100 * Math.sin(frame.time * 2 * Math.PI / 2000) + 600);
		}, layer);

	var redlevel9anim1 = new Konva.Animation(function(frame) {
		redspikes.setX(100 * Math.sin(frame.time * 2 * Math.PI / 2000) + 350);
		}, layer);

	var redlevel9anim2 = new Konva.Animation(function(frame) {
		moreredspikes.setX(100 * Math.sin(frame.time * 2 * Math.PI / 2000) + 550);
		}, layer);

	var blulevel9anim1 = new Konva.Animation(function(frame) {
		bluspikes.setX(100 * Math.sin(frame.time * 2 * Math.PI / 2000) + 350);
		}, layer);

	var blulevel9anim2 = new Konva.Animation(function(frame) {
		morebluspikes.setX(100 * Math.sin(frame.time * 2 * Math.PI / 2000) + 550);
		}, layer);

	//Player movement (and switching for local)
	document.addEventListener('keydown', (event) => {
	const keyName = event.key;
	if(keyName=="ArrowRight"&&color=='red'&&redsquare.getAbsolutePosition().x<850)
	{
		redsquare.move({x: 25,y: 0});
		layer.draw();
	}
	  else if(keyName=="ArrowRight"&&color=='blue'&&blusquare.getAbsolutePosition().x<850)
	{
		blusquare.move({x: 25,y: 0});
		layer.draw();
	}
	else if(keyName=="ArrowLeft"&&color=='red'&&redsquare.getAbsolutePosition().x>0)
	{
		redsquare.move({x: -25,y: 0});
		layer.draw();
	}
	else if(keyName=="ArrowLeft"&&color=='blue'&&blusquare.getAbsolutePosition().x>0)
	{
		blusquare.move({x: -25,y: 0});
		layer.draw();
	}

  //SOCKET.IO STUFF:
  //SEND NEW POSITION DATA TO SERVER
  var data = {};
  data.color = color;
  data.redpos = redsquare.getAbsolutePosition();
  data.bluepos = blusquare.getAbsolutePosition();

  socket.emit('square_pos', data);
	});

    // add the shape to the layer
	topGroup.add(redsquare);
	topGroup.add(redFloor);
	topGroup.add(redspikes);
	topGroup.add(bigredspikes);
	topGroup.add(moreredspikes);
	bottomGroup.add(blusquare);
	bottomGroup.add(bluFloor);
	bottomGroup.add(bluspikes);
	bottomGroup.add(bigbluspikes);
	bottomGroup.add(morebluspikes);
	textGroup.add(player);
	textGroup.add(loading);
	textGroup.add(level1);
	textGroup.add(level2);
	textGroup.add(level3);
	textGroup.add(level4);
	textGroup.add(level5);
	textGroup.add(level6);
	textGroup.add(level7);
	textGroup.add(level8);
	textGroup.add(level9);
	textGroup.add(level10);
	layer.add(topGroup);
	layer.add(bottomGroup);
	layer.add(textGroup);
	layer.add(platform);

    // add the layer to the stage
    stage.add(layer);


	//Collision detection.
	document.addEventListener('keydown', (event) => {
				if (haveIntersection(redspikes, redsquare)&&redspikes.isVisible()==true) {
                    console.log("redcollision");
					//reset();
          socket.emit('reset', true);
                }
				if (haveIntersection(bigredspikes, redsquare)&&bigredspikes.isVisible()==true) {
                    console.log("redcollision");
					//reset();
          socket.emit('reset', true);
                }
				if (haveIntersection(redspikes, redsquare)&&redspikes.isVisible()==false&&level>=10) {
                    console.log("redcollision");
					//reset();
          socket.emit('reset', true);
                }
				if (haveIntersection(moreredspikes, redsquare)&&moreredspikes.isVisible()==false&&level>=10) {
                    console.log("redcollision");
					//reset();
          socket.emit('reset', true);
                }
				if (haveIntersection(moreredspikes, redsquare)&&moreredspikes.isVisible()==true) {
                    console.log("redcollision");
					//reset();
          socket.emit('reset', true);
                }
				if (haveIntersection(bluspikes, blusquare)&&bluspikes.isVisible()==true) {
                    console.log("blucollision");
					//reset();
          socket.emit('reset', true);
                }
				if (haveIntersection(bigbluspikes, blusquare)&&bigbluspikes.isVisible()==true) {
                    console.log("blucollision");
					//reset();
          socket.emit('reset', true);
                }
				if (haveIntersection(morebluspikes, blusquare)&&morebluspikes.isVisible()==true) {
                    console.log("blucollision");
					//reset();
          socket.emit('reset', true);
                }
				if (haveIntersection(bluspikes, blusquare)&&bluspikes.isVisible()==false&&level>=10) {
                    console.log("blucollision");
					//reset();
          socket.emit('reset', true);
                }
				if (haveIntersection(morebluspikes, blusquare)&&morebluspikes.isVisible()==false&&level>=10) {
                    console.log("blucollision");
					//reset();
          socket.emit('reset', true);
                }
				if(haveIntersection(redsquare, platform)) {
					redsquare.y((redsquare.getAbsolutePosition().y-100)-(redsquare.getAbsolutePosition().y-platform.getAbsolutePosition().y+((200-platform.getAbsolutePosition().y)/2)-.5));
					layer.draw();
				}
				if(haveIntersection(blusquare, platform)) {
					blusquare.y((blusquare.getAbsolutePosition().y-300)-(blusquare.getAbsolutePosition().y-platform.getAbsolutePosition().y+((400-platform.getAbsolutePosition().y)/2)-.5));
					layer.draw();
				}
				if(platform.getAbsolutePosition().x > redsquare.getAbsolutePosition().x + redsquare.width() || platform.getAbsolutePosition().x + platform.width() < redsquare.getAbsolutePosition().x)
				{
					redsquare.y(75);
					layer.draw();
				}
				if(platform.getAbsolutePosition().x > blusquare.getAbsolutePosition().x + blusquare.width() || platform.getAbsolutePosition().x + platform.width() < blusquare.getAbsolutePosition().x)
				{
					blusquare.y(75);
					layer.draw();
				}
				/*if(redsquare.getAbsolutePosition().x==850&&blusquare.getAbsolutePosition().x==850)
				{
					//reset();
          console.log(level);
          level=level+1;
          console.log(level);
					//levelup(level);
          //SOCKET.IO STUFF
          //socket.emit('level', level);
				}*/
        });

		function haveIntersection(r1, r2) {
            return !(
                r2.getAbsolutePosition().x > r1.getAbsolutePosition().x + r1.width()+5 ||
                r2.getAbsolutePosition().x + r2.width() < r1.getAbsolutePosition().x-5 ||
                r2.getAbsolutePosition().y > r1.getAbsolutePosition().y + r1.height()-5 ||
                r2.getAbsolutePosition().y + r2.height() < r1.getAbsolutePosition().y+5
            );
        }

	//Reset the level on a "death".
		function reset() {
		redsquare.x(0);
		redsquare.y(75);
		blusquare.x(0);
		blusquare.y(75);
		platform.x(50);
		platform.y(262.5);
		layer.draw();
		}

	//How to go from one level to the next.
		function levelup(level) {
		console.log("Begin Level "+level);
		if(level==1)
		{
			player.hide();
			loading.hide();
			redsquare.x(0);
			redsquare.y(75);
			blusquare.show();
			level1.show();
			redFloor.show();
			bluFloor.show();
			platform.show();
			layer.draw();
		}
		if(level==2)
		{
			redspikes.x(450);
			redspikes.y(85);
			bluspikes.x(450);
			bluspikes.y(85);
			bluspikes.show();
			redspikes.show();
			level1.hide();
			level2.show();
			layer.draw();
		}
		if(level==3)
		{
			redlevel3anim.start();
			blulevel3anim.start();
			level2.hide();
			level3.show();
			layer.draw();
		}
		if(level==4)
		{
			redlevel3anim.stop();
			blulevel3anim.stop();
			redspikes.hide();
			bigredspikes.show();
			bigredspikes.y(80);
			redlevel4anim.start();
			bluspikes.x(450);
			bluspikes.y(85);
			level3.hide();
			level4.show();
			layer.draw();
		}
		if(level==5)
		{
			bigredspikes.hide();
			redspikes.show();
			moreredspikes.show();
			morebluspikes.show();
			redlevel4anim.stop();
			redspikes.x(300);
			redspikes.y(85);
			moreredspikes.x(600);
			moreredspikes.y(85);
			bluspikes.x(300);
			bluspikes.y(85);
			morebluspikes.x(600);
			morebluspikes.y(85);
			if(color=='red')
			{bottomGroup.hide();}
			else
			{topGroup.hide();}
			level4.hide();
			level5.show();
			layer.draw();
		}
		if(level==6)
		{
			blulevel6anim1.start();
			blulevel6anim2.start();
			redlevel6anim1.start();
			redlevel6anim2.start();
			if(color=='red')
			{bottomGroup.hide();}
			else
			{topGroup.hide();}
			level5.hide();
			level6.show();
			layer.draw();
		}
		if(level==7)
		{
			blulevel6anim1.stop();
			blulevel6anim2.stop();
			redlevel6anim1.stop();
			redlevel6anim2.stop();
			redspikes.hide();
			moreredspikes.hide();
			bluspikes.hide();
			morebluspikes.hide();
			bigredspikes.show();
			bigredspikes.x(450);
			bigredspikes.y(75);
			bigbluspikes.show();
			bigbluspikes.x(450);
			bigbluspikes.y(75);
			if(color=='red')
			{bottomGroup.hide();}
			else
			{topGroup.hide();}
			level6.hide();
			level7.show();
			layer.draw();
		}
		if(level==8)
		{
			redspikes.show();
			moreredspikes.show();
			bigredspikes.show();
			redspikes.x(300);
			redspikes.y(85);
			moreredspikes.x(600);
			moreredspikes.y(85);
			bigredspikes.x(450);
			bigredspikes.y(75);
			bluspikes.show();
			morebluspikes.show();
			bigbluspikes.show();
			bluspikes.x(300);
			bluspikes.y(85);
			morebluspikes.x(600);
			morebluspikes.y(85);
			bigbluspikes.x(450);
			bigbluspikes.y(75);
			blulevel8anim1.start();
			blulevel8anim2.start();
			redlevel8anim1.start();
			redlevel8anim2.start();
			level7.hide();
			level8.show()
			layer.draw();
		}
		if(level==9)
		{
			blulevel8anim1.stop();
			blulevel8anim2.stop();
			redlevel8anim1.stop();
			redlevel8anim2.stop();
			topGroup.show();
			redspikes.show();
			moreredspikes.show();
			bottomGroup.show();
			bluspikes.show();
			morebluspikes.show();
			redspikes.x(300);
			redspikes.y(285);
			moreredspikes.x(600);
			moreredspikes.y(285);
			bluspikes.x(300);
			bluspikes.y(-115);
			morebluspikes.x(600);
			morebluspikes.y(-115);
			blulevel9anim1.start();
			blulevel9anim2.start();
			redlevel9anim1.start();
			redlevel9anim2.start();
			level8.hide();
			level1.hide()
			level9.show();
			layer.draw();
		}
		if(level==10)
		{
			blulevel9anim1.stop();
			blulevel9anim2.stop();
			redlevel9anim1.stop();
			redlevel9anim2.stop();
			redspikes.x(300);
			redspikes.y(85);
			moreredspikes.x(600);
			moreredspikes.y(85);
			bigredspikes.hide();
			bluspikes.x(300);
			bluspikes.y(85);
			morebluspikes.x(600);
			morebluspikes.y(85);
			bigbluspikes.hide();
			if(color=='red')
			{redspikes.hide();
			moreredspikes.hide();}
			else
			{bluspikes.hide();
			morebluspikes.hide();}
			level9.hide();
			level10.show();
			layer.draw();
		}
		}

    //MORE SOCKET.IO STUFF

    //CHARACTER SYNCHRONIZATION
    socket.on('square_pos', function(data) {
      //console.log(data);
      console.log(data.bluepos.x, data.redpos.x);

      if (color == 'red' && data.color == 'blue') {
        blusquare.setAbsolutePosition(data.bluepos);
        layer.draw();
      }
      if (color == 'blue' && data.color == 'red') {
        redsquare.setAbsolutePosition(data.redpos);
        layer.draw();
      }
      if (data.bluepos.x == 850 && data.redpos.x == 850) {
        //console.log(level);
        //level = level + 1;
        //console.log(level);
        socket.emit('level', level + 1);
      }
    });

    //LEVEL SYNCHRONIZATION
    socket.on('level', function(new_level) {
      if (new_level == level + 1) {
        level = level + 1;
        reset();
        levelup(new_level);
      } //else, level is too high -- do nothing
    });

    socket.on('reset', function(x) {
      console.log(x);
      if (x) {
        reset();
      }
    })

    //PLATFORM SYNCHRONIZATION
    platform.on('dragmove', function() {
      var pos = platform.getAbsolutePosition();
      socket.emit('platform_pos', pos);
    });

    socket.on('platform_pos', function(pos) {
      //move platform to new position
      console.log(pos.x, pos.y);
      platform.setAbsolutePosition(pos);
      layer.draw();
    });

  </script>

</body>

</html>
